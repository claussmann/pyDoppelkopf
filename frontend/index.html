<!DOCTYPE html>
    <body>

        <div id="create" style="display: block;">
            <button onclick="javascript:create_new_game()">Create new Game</button>
            <button onclick="javascript:switch_view('JOIN')">Join existing Game</button>
        </div>
        <div id="login" style="display: none;">
            <input type="text" id="gid_field" placeholder="Game ID">
            <input type="text" id="pname" placeholder="Player Name">
            <button onclick="javascript:login_to_game(gid_field.value, pname.value)">Join</button>
        </div>
        <div id="play" style="display: none;">
            <p>
                Game ID: <span id="display_game_id"></span>.
                Status: <span id="display_game_status"></span>.
            </p>
            <p>
                Left: <span id="player_left"></span><br>
                Front: <span id="player_front"></span><br>
                Right: <span id="player_right"></span><br>
                Self: <span id="player_self"></span><br>
            </p>
            <p>
                <button onclick="javascript:lay_card(0)" id="card_0">--</button>
                <button onclick="javascript:lay_card(1)" id="card_1">--</button>
                <button onclick="javascript:lay_card(2)" id="card_2">--</button>
                <button onclick="javascript:lay_card(3)" id="card_3">--</button>
                <button onclick="javascript:lay_card(4)" id="card_4">--</button>
                <button onclick="javascript:lay_card(5)" id="card_5">--</button>
                <button onclick="javascript:lay_card(6)" id="card_6">--</button>
                <button onclick="javascript:lay_card(7)" id="card_7">--</button>
                <button onclick="javascript:lay_card(8)" id="card_8">--</button>
                <button onclick="javascript:lay_card(9)" id="card_9">--</button>
                <button onclick="javascript:lay_card(10)" id="card_10">--</button>
                <button onclick="javascript:lay_card(11)" id="card_11">--</button>
            </p>
        </div>

    </body>
    <script>
        const HOST = "localhost:8000"
        var PLAYER_TOKEN = "";
        var PLAYER_NAME = "";
        var GAME_ID = "";
        var EVENT_ID = 0;
        var PERIODIC_CALL = 0;
        var TABLE = [];
        var HAND_CARDS = [];
        var GAMEMODE = "GESUND";

        function switch_view(view){
            if(view === "CREATE"){
                document.getElementById("create").style.display = "block";
                document.getElementById("login").style.display = "none";
                document.getElementById("play").style.display = "none";
            }
            if(view === "JOIN"){
                document.getElementById("create").style.display = "none";
                document.getElementById("login").style.display = "block";
                document.getElementById("play").style.display = "none";
            }
            if(view === "PLAY"){
                document.getElementById("create").style.display = "none";
                document.getElementById("login").style.display = "none";
                document.getElementById("play").style.display = "block";
            }
        }

        async function create_new_game() {
            var url = "http://" + HOST + "/new_game";
            const response = await fetch(url, {
                method: "POST",
                headers: {"Content-Type": "application/json",},
                cache: "no-cache",
            });
            if(response.status != 200){
                alert("Error (ID: 1)");
                return;
            }
            var game_obj = await response.json();
            gid = game_obj.game_id;
            console.log("INFO: Game ID is " + gid)
            document.getElementById("gid_field").value = gid;
            switch_view("JOIN");
        }

        async function login_to_game(game_id, player_name) {
            var url = "http://" + HOST + "/" + game_id + "/join?player_name=" + player_name;
            const response = await fetch(url, {
                method: "POST",
                headers: {"Content-Type": "application/json",},
                cache: "no-cache",
            });
            if(response.status != 200){
                alert("Error (ID: 2)");
                console.log(response);
                return;
            }
            var token_obj = await response.json();
            PLAYER_TOKEN = token_obj.token;
            PLAYER_NAME = token_obj.player_name;
            GAME_ID = game_id
            console.log("INFO: Your token is " + PLAYER_TOKEN);
            document.getElementById("display_game_id").textContent=GAME_ID;
            switch_view("PLAY")
            PERIODIC_CALL = setInterval(process_events, 5000);
        }

        async function process_events() {
            var url = "http://" + HOST + "/" + GAME_ID + "/event?from_event_id=" + EVENT_ID;
            const response = await fetch(url, {
                method: "GET",
                headers: {"Content-Type": "application/json",},
                cache: "no-cache",
            });
            if(response.status != 200){
                alert("Error (ID: 3)");
                console.log(response);
                return;
            }
            var event_list = await response.json();
            event_list.forEach( (e) => {
                console.log(e);
                EVENT_ID = e.e_id + 1;
                switch(e.e_type){
                    case "SERVER":
                        switch(e.content){
                            case "PLAYER_JOINED":
                                TABLE.push(e.add_data)
                                update_table();
                                break;
                            case "GAME_STARTED":
                                update_own_cards();
                                break;
                        }
                        break;
                }
            })
        }

        function update_table(){
            var own_index = TABLE.indexOf(PLAYER_NAME);
            document.getElementById("player_self").textContent=TABLE[own_index];
            document.getElementById("player_left").textContent=TABLE[(own_index + 1) % 4];
            document.getElementById("player_front").textContent=TABLE[(own_index + 2) % 4];
            document.getElementById("player_right").textContent=TABLE[(own_index + 3) % 4];
        }

        async function update_own_cards(){
            var url = "http://" + HOST + "/" + GAME_ID + "/cards?player_token=" + PLAYER_TOKEN;
            const response = await fetch(url, {
                method: "GET",
                headers: {"Content-Type": "application/json",},
                cache: "no-cache",
            });
            if(response.status != 200){
                alert("Error (ID: 4)");
                console.log(response);
                return;
            }
            HAND_CARDS = await response.json();
            sort_cards();
            console.log(HAND_CARDS);
            for(i = 0; i < HAND_CARDS.length; i++){
                document.getElementById("card_"+i).textContent=HAND_CARDS[i];
            }
            for(i = HAND_CARDS.length; i < 12; i++){
                document.getElementById("card_"+i).textContent="--";
            }
        }

        function lay_card(card_slot) {
            var event = {
                "sender": PLAYER_NAME,
                "e_type": "KARTE",
                "content": HAND_CARDS[card_slot],
            }
            if(send_event(event)){
                HAND_CARDS.splice(card_slot, 1);
                for(i = 0; i < HAND_CARDS.length; i++){
                    document.getElementById("card_"+i).textContent=HAND_CARDS[i];
                }
                for(i = HAND_CARDS.length; i < 12; i++){
                    document.getElementById("card_"+i).textContent="--";
                }
            } else {
                console.log("Card is not allowed.");
            }
        }

        async function send_event(event) {
            var url = "http://" + HOST + "/" + GAME_ID + "/event?player_token=" + PLAYER_TOKEN;
            const response = await fetch(url, {
                method: "POST",
                headers: {"Content-Type": "application/json",},
                cache: "no-cache",
                body: JSON.stringify(event),
            });
            if(response.status != 200){
                alert("Error (ID: 5)");
                console.log(response);
                return false;
            }
            var event_resp = await response.json();
            return event_resp.successful;
        }

        function sort_cards(){
            ranking = [];
            if(GAMEMODE == "GESUND"){
                ranking = [
                    "SUPERSCHWEIN", "SCHWEIN", "H10", "CQ", "SQ", "HQ", "DQ", "CJ", "SJ", "HJ", "DJ",
                    "DA", "D10", "DK", "D9", "CA", "C10", "CK", "C9", "SA", "S10", "SK", "S9", "HA", "HK", "H9",
                ]
            }
            console.log(ranking)
            HAND_CARDS.sort((a, b) => ranking.indexOf(a) - ranking.indexOf(b));
            console.log(HAND_CARDS);
        }

    </script>
</html>