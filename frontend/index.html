<!DOCTYPE html>
    <body>

        <div id="create" style="display: block;">
            <button onclick="javascript:create_new_game()">Create new Game</button>
            <button onclick="javascript:switch_view('JOIN')">Join existing Game</button>
        </div>
        <div id="login" style="display: none;">
            <input type="text" id="gid_field" placeholder="Game ID">
            <input type="text" id="pname" placeholder="Player Name">
            <button onclick="javascript:login_to_game(gid_field.value, pname.value)">Join</button>
        </div>
        <div id="play" style="display: none;">
            <p>
                Game ID: <span id="display_game_id"></span>.
                Status: <span id="display_game_status"></span>.
            </p>
            <p>
                Left: <span id="player_left"></span><br>
                Front: <span id="player_front"></span><br>
                Right: <span id="player_right"></span><br>
                Self: <span id="player_self"></span><br>
            </p>
            <p>
                <span id="card_0"></span>
                <span id="card_1"></span>
                <span id="card_2"></span>
                <span id="card_3"></span>
                <span id="card_4"></span>
                <span id="card_5"></span>
                <span id="card_6"></span>
                <span id="card_7"></span>
                <span id="card_8"></span>
                <span id="card_9"></span>
                <span id="card_10"></span>
                <span id="card_11"></span>
            </p>
        </div>

    </body>
    <script>
        const HOST = "localhost:8000"
        var PLAYER_TOKEN = "";
        var PLAYER_NAME = "";
        var GAME_ID = "";
        var EVENT_ID = 0;
        var PERIODIC_CALL = 0;
        var TABLE = [];

        function switch_view(view){
            if(view === "CREATE"){
                document.getElementById("create").style.display = "block";
                document.getElementById("login").style.display = "none";
                document.getElementById("play").style.display = "none";
            }
            if(view === "JOIN"){
                document.getElementById("create").style.display = "none";
                document.getElementById("login").style.display = "block";
                document.getElementById("play").style.display = "none";
            }
            if(view === "PLAY"){
                document.getElementById("create").style.display = "none";
                document.getElementById("login").style.display = "none";
                document.getElementById("play").style.display = "block";
            }
        }

        async function create_new_game() {
            var url = "http://" + HOST + "/new_game";
            const response = await fetch(url, {
                method: "POST",
                headers: {"Content-Type": "application/json",},
                cache: "no-cache",
            });
            if(response.status != 200){
                alert("Something went wrong.");
                return;
            }
            var game_obj = await response.json();
            gid = game_obj.game_id;
            console.log("INFO: Game ID is " + gid)
            document.getElementById("gid_field").value = gid;
            switch_view("JOIN");
        }

        async function login_to_game(game_id, player_name) {
            var url = "http://" + HOST + "/" + game_id + "/join?player_name=" + player_name;
            const response = await fetch(url, {
                method: "POST",
                headers: {"Content-Type": "application/json",},
                cache: "no-cache",
            });
            if(response.status != 200){
                if(response.status == 422){
                    alert("The name you provided might not match the criteria.");
                } else{
                    alert("Something went wrong.");
                }
                console.log(response);
                return;
            }
            var token_obj = await response.json();
            PLAYER_TOKEN = token_obj.token;
            PLAYER_NAME = token_obj.player_name;
            GAME_ID = game_id
            console.log("INFO: Your token is " + PLAYER_TOKEN);
            document.getElementById("display_game_id").textContent=GAME_ID;
            switch_view("PLAY")
            PERIODIC_CALL = setInterval(process_events, 5000);
        }

        async function process_events() {
            var url = "http://" + HOST + "/" + GAME_ID + "/event?from_event_id=" + EVENT_ID;
            const response = await fetch(url, {
                method: "GET",
                headers: {"Content-Type": "application/json",},
                cache: "no-cache",
            });
            if(response.status != 200){
                alert("Something went wrong.");
                console.log(response);
                return;
            }
            var event_list = await response.json();
            event_list.forEach( (e) => {
                console.log(e);
                EVENT_ID = e.e_id + 1;
                switch(e.e_type){
                    case "SERVER":
                        switch(e.content){
                            case "PLAYER_JOINED":
                                TABLE.push(e.add_data)
                                update_table();
                                break;
                            case "GAME_STARTED":
                                update_own_cards();
                                break;
                        }
                        break;
                }
            })
        }

        function update_table(){
            var own_index = TABLE.indexOf(PLAYER_NAME);
            document.getElementById("player_self").textContent=TABLE[own_index];
            document.getElementById("player_left").textContent=TABLE[(own_index + 1) % 4];
            document.getElementById("player_front").textContent=TABLE[(own_index + 2) % 4];
            document.getElementById("player_right").textContent=TABLE[(own_index + 3) % 4];
        }

        async function update_own_cards(){
            var url = "http://" + HOST + "/" + GAME_ID + "/cards?player_token=" + PLAYER_TOKEN;
            const response = await fetch(url, {
                method: "GET",
                headers: {"Content-Type": "application/json",},
                cache: "no-cache",
            });
            if(response.status != 200){
                alert("Something went wrong when updating cards.");
                console.log(response);
                return;
            }
            card_list = await response.json();
            for(i = 0; i < card_list.length; i++){
                document.getElementById("card_"+i).textContent=card_list[i];
            }
            for(i = card_list.length; i < 12; i++){
                document.getElementById("card_"+i).textContent="";
            }
        }

    </script>
</html>